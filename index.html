<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ìš” ì‹œê³µì‚¬ ì¬ë¬´í˜„í™© ì§‘ê³„ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto p-6">
        <!-- í—¤ë” -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow-lg p-8 mb-6">
            <h1 class="text-3xl font-bold mb-2">ğŸ—ï¸ ì£¼ìš” ì‹œê³µì‚¬ ì¬ë¬´í˜„í™© ì§‘ê³„ ì‹œìŠ¤í…œ</h1>
            <p class="text-blue-100">DART APIë¥¼ í†µí•œ ì‹¤ì‹œê°„ ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘</p>
            <div class="mt-4 flex gap-4">
                <span class="bg-blue-500 bg-opacity-50 px-3 py-1 rounded-full text-sm">
                    âœ… ì‹¤ì‹œê°„ DART ì—°ë™
                </span>
                <span class="bg-blue-500 bg-opacity-50 px-3 py-1 rounded-full text-sm">
                    âœ… Excel ë‹¤ìš´ë¡œë“œ
                </span>
            </div>
        </div>

        <!-- ì¡°íšŒ ì¡°ê±´ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ ì¡°íšŒ ì¡°ê±´</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì¡°íšŒ ì—°ë„</label>
                    <select id="yearSelect" class="w-full p-2 border rounded">
                        <option value="2023">2023ë…„</option>
                        <option value="2022">2022ë…„</option>
                        <option value="2021">2021ë…„</option>
                        <option value="2020">2020ë…„</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë³´ê³ ì„œ ìœ í˜•</label>
                    <select id="reportType" class="w-full p-2 border rounded">
                        <option value="11011">ì‚¬ì—…ë³´ê³ ì„œ</option>
                        <option value="11012">ë°˜ê¸°ë³´ê³ ì„œ</option>
                        <option value="11013">1ë¶„ê¸°ë³´ê³ ì„œ</option>
                        <option value="11014">3ë¶„ê¸°ë³´ê³ ì„œ</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì¬ë¬´ì œí‘œ êµ¬ë¶„</label>
                    <select id="fsDiv" class="w-full p-2 border rounded">
                        <option value="CFS">ì—°ê²°ì¬ë¬´ì œí‘œ</option>
                        <option value="OFS">ë³„ë„ì¬ë¬´ì œí‘œ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ê¸°ì—… ì„ íƒ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ¢ ê¸°ì—… ì„ íƒ</h2>
            <div id="companyList" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <!-- ê¸°ì—… ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì‹¤í–‰ ë²„íŠ¼ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex gap-4 justify-center">
                <button onclick="collectData()" 
                        class="bg-green-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-700">
                    ğŸ“Š ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
                </button>
                <button onclick="downloadExcel()" 
                        class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700">
                    ğŸ“¥ Excel ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
        </div>

        <!-- ì§„í–‰ ìƒí™© -->
        <div id="progressSection" class="bg-white rounded-lg shadow p-6 mb-6" style="display: none;">
            <h2 class="text-xl font-semibold mb-4">â³ ì§„í–‰ ìƒí™©</h2>
            <div class="mb-4">
                <div class="flex justify-between mb-2">
                    <span id="progressText">ì¤€ë¹„ ì¤‘...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- ê²°ê³¼ í…Œì´ë¸” -->
        <div id="resultsSection" class="bg-white rounded-lg shadow p-6" style="display: none;">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š ìˆ˜ì§‘ëœ ì¬ë¬´ ë°ì´í„°</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead class="bg-gray-100">
                        <tr id="tableHeaders"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ì£¼ìš” ê±´ì„¤ì‚¬ ëª©ë¡ (ì‹¤ì œ DART ê¸°ì—…ì½”ë“œ)
        const companies = [
            { name: 'ì‚¼ì„±ë¬¼ì‚°', code: '00104928' },
            { name: 'í˜„ëŒ€ê±´ì„¤', code: '00104256' },
            { name: 'ëŒ€ë¦¼ì‚°ì—…', code: '00104337' },
            { name: 'GSê±´ì„¤', code: '00113739' },
            { name: 'í¬ìŠ¤ì½”ê±´ì„¤', code: '00149885' },
            { name: 'ëŒ€ìš°ê±´ì„¤', code: '00259630' },
            { name: 'ë¡¯ë°ê±´ì„¤', code: '00356361' },
            { name: 'HDCí˜„ëŒ€ì‚°ì—…ê°œë°œ', code: '00104604' },
            { name: 'DLì´ì•¤ì”¨', code: '00356370' },
            { name: 'í•œí™”ê±´ì„¤', code: '01247160' }
        ];

        let collectedData = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            displayCompanies();
        };

        // ê¸°ì—… ëª©ë¡ í‘œì‹œ
        function displayCompanies() {
            const container = document.getElementById('companyList');
            container.innerHTML = companies.map(company => `
                <label class="flex items-center p-2 hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" class="company-checkbox mr-2" 
                           value="${company.code}" data-name="${company.name}" checked>
                    <span class="text-sm">${company.name}</span>
                </label>
            `).join('');
        }

        // ë°ì´í„° ìˆ˜ì§‘
        async function collectData() {
            const selectedCompanies = [];
            document.querySelectorAll('.company-checkbox:checked').forEach(checkbox => {
                selectedCompanies.push({
                    code: checkbox.value,
                    name: checkbox.dataset.name
                });
            });

            if (selectedCompanies.length === 0) {
                alert('ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ê¸°ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const year = document.getElementById('yearSelect').value;
            const reportType = document.getElementById('reportType').value;
            const fsDiv = document.getElementById('fsDiv').value;

            // UI ì´ˆê¸°í™”
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            collectedData = [];

            let currentProgress = 0;
            const totalTasks = selectedCompanies.length;

            // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            const updateProgress = (current, total, text) => {
                const percent = Math.round((current / total) * 100);
                document.getElementById('progressText').textContent = text;
                document.getElementById('progressPercent').textContent = `${percent}%`;
                document.getElementById('progressBar').style.width = `${percent}%`;
            };

            // ê° ê¸°ì—…ë³„ë¡œ ë°ì´í„° ìˆ˜ì§‘
            for (let i = 0; i < selectedCompanies.length; i++) {
                const company = selectedCompanies[i];
                updateProgress(i, totalTasks, `${company.name} ë°ì´í„° ìˆ˜ì§‘ ì¤‘...`);

                try {
                    // API í˜¸ì¶œ
                    const response = await fetch(
                        `/api/dart?company=${company.code}&year=${year}&reportType=${reportType}&fsDiv=${fsDiv}`
                    );
                    
                    const data = await response.json();
                    
                    if (data.status === '000' && data.summary) {
                        // ì¬ë¬´ë¹„ìœ¨ ê³„ì‚°
                        const summary = data.summary;
                        const debtRatio = summary.totalAssets && summary.totalLiabilities
                            ? ((summary.totalLiabilities / summary.totalAssets) * 100).toFixed(2)
                            : null;
                        
                        const roe = summary.totalEquity && summary.netIncome
                            ? ((summary.netIncome / summary.totalEquity) * 100).toFixed(2)
                            : null;

                        collectedData.push({
                            company: company.name,
                            year: year,
                            sales: summary.sales,
                            operatingProfit: summary.operatingProfit,
                            netIncome: summary.netIncome,
                            totalAssets: summary.totalAssets,
                            totalLiabilities: summary.totalLiabilities,
                            totalEquity: summary.totalEquity,
                            debtRatio: debtRatio,
                            roe: roe,
                            status: 'ì¡°íšŒ ì„±ê³µ'
                        });
                    } else {
                        collectedData.push({
                            company: company.name,
                            year: year,
                            sales: null,
                            operatingProfit: null,
                            netIncome: null,
                            totalAssets: null,
                            totalLiabilities: null,
                            totalEquity: null,
                            debtRatio: null,
                            roe: null,
                            status: data.message || 'ë°ì´í„° ì—†ìŒ'
                        });
                    }
                } catch (error) {
                    console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                    collectedData.push({
                        company: company.name,
                        year: year,
                        status: 'ì¡°íšŒ ì‹¤íŒ¨'
                    });
                }

                // API í˜¸ì¶œ ê°„ ë”œë ˆì´ (DART API ì œí•œ ê³ ë ¤)
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            updateProgress(totalTasks, totalTasks, 'ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ!');
            displayResults();
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResults() {
            if (collectedData.length === 0) return;

            document.getElementById('resultsSection').style.display = 'block';

            // í…Œì´ë¸” í—¤ë”
            const headers = [
                'íšŒì‚¬ëª…', 'ì—°ë„', 'ë§¤ì¶œì•¡', 'ì˜ì—…ì´ìµ', 'ìˆœì´ìµ',
                'ì´ìì‚°', 'ì´ë¶€ì±„', 'ìê¸°ìë³¸', 'ë¶€ì±„ë¹„ìœ¨(%)', 'ROE(%)', 'ìƒíƒœ'
            ];
            
            document.getElementById('tableHeaders').innerHTML = headers.map(h => 
                `<th class="px-4 py-2 text-left text-sm font-medium">${h}</th>`
            ).join('');

            // í…Œì´ë¸” ë°”ë””
            document.getElementById('tableBody').innerHTML = collectedData.map(row => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm">${row.company}</td>
                    <td class="px-4 py-2 text-sm">${row.year}</td>
                    <td class="px-4 py-2 text-sm text-right">${formatNumber(row.sales)}</td>
                    <td class="px-4 py-2 text-sm text-right">${formatNumber(row.operatingProfit)}</td>
                    <td class="px-4 py-2 text-sm text-right">${formatNumber(row.netIncome)}</td>
                    <td class="px-4 py-2 text-sm text-right">${formatNumber(row.totalAssets)}</td>
                    <td class="px-4 py-2 text-sm text-right">${formatNumber(row.totalLiabilities)}</td>
                    <td class="px-4 py-2 text-sm text-right">${formatNumber(row.totalEquity)}</td>
                    <td class="px-4 py-2 text-sm text-right">${row.debtRatio || '-'}${row.debtRatio ? '%' : ''}</td>
                    <td class="px-4 py-2 text-sm text-right">${row.roe || '-'}${row.roe ? '%' : ''}</td>
                    <td class="px-4 py-2 text-sm">
                        <span class="px-2 py-1 rounded text-xs ${
                            row.status === 'ì¡°íšŒ ì„±ê³µ' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${row.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // ìˆ«ì í¬ë§·íŒ…
        function formatNumber(value) {
            if (!value) return '-';
            return new Intl.NumberFormat('ko-KR').format(Math.round(value / 100000000)) + 'ì–µ';
        }

        // Excel ë‹¤ìš´ë¡œë“œ
        function downloadExcel() {
            if (collectedData.length === 0) {
                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•´ì£¼ì„¸ìš”.');
                return;
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(collectedData.map(row => ({
                'íšŒì‚¬ëª…': row.company,
                'ì—°ë„': row.year,
                'ë§¤ì¶œì•¡(ì–µì›)': row.sales ? Math.round(row.sales / 100000000) : '',
                'ì˜ì—…ì´ìµ(ì–µì›)': row.operatingProfit ? Math.round(row.operatingProfit / 100000000) : '',
                'ìˆœì´ìµ(ì–µì›)': row.netIncome ? Math.round(row.netIncome / 100000000) : '',
                'ì´ìì‚°(ì–µì›)': row.totalAssets ? Math.round(row.totalAssets / 100000000) : '',
                'ì´ë¶€ì±„(ì–µì›)': row.totalLiabilities ? Math.round(row.totalLiabilities / 100000000) : '',
                'ìê¸°ìë³¸(ì–µì›)': row.totalEquity ? Math.round(row.totalEquity / 100000000) : '',
                'ë¶€ì±„ë¹„ìœ¨(%)': row.debtRatio || '',
                'ROE(%)': row.roe || '',
                'ìƒíƒœ': row.status
            })));

            XLSX.utils.book_append_sheet(wb, ws, "ì¬ë¬´í˜„í™©");
            XLSX.writeFile(wb, `ê±´ì„¤ì‚¬_ì¬ë¬´í˜„í™©_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
    </script>
</body>
</html>
